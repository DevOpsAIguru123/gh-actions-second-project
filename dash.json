{
  "name": "Databricks Value Hub (System Tables)",
  "datasets": [
    {
      "name": "ds_total_spend",
      "displayName": "Total Spend Data",
      "query": "SELECT usage_date, sum(usage_quantity * list_price) as total_cost\nFROM system.billing.usage \nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1 ORDER BY 1"
    },
    {
      "name": "ds_active_users",
      "displayName": "Active Users Data",
      "query": "SELECT count(distinct user_identity.email) as active_users \nFROM system.access.audit \nWHERE event_date >= now() - interval 30 day AND action_name = 'commandRan'"
    },
    {
      "name": "ds_top_project",
      "displayName": "Top Project Data",
      "query": "SELECT coalesce(custom_tags.project_name, 'Unattributed') as project, sum(usage_quantity * list_price) as total_cost\nFROM system.billing.usage \nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1 ORDER BY 2 DESC LIMIT 1"
    },
    {
      "name": "ds_job_success",
      "displayName": "Job Success Rate Data",
      "query": "SELECT 100 * sum(case when run_status = 'SUCCESS' then 1 else 0 end) / count(*) as success_rate\nFROM system.operational_data.jobs_history\nWHERE start_time >= now() - interval 30 day"
    },
    {
      "name": "ds_cost_trend",
      "displayName": "Cost Trend Data",
      "query": "SELECT usage_date, sum(usage_quantity * list_price) as `Current Period`\nFROM system.billing.usage \nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1"
    },
    {
      "name": "ds_workload_cost",
      "displayName": "Workload Cost Data",
      "query": "SELECT sku_name, sum(usage_quantity * list_price) as total_cost\nFROM system.billing.usage \nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1 ORDER BY 2 DESC"
    },
    {
      "name": "ds_project_cost_breakdown",
      "displayName": "Project Cost Breakdown Data",
      "query": "SELECT coalesce(custom_tags.project_name, 'Unattributed') as project, sum(usage_quantity * list_price) as total_cost\nFROM system.billing.usage \nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1 ORDER BY 2 DESC LIMIT 10"
    },
    {
      "name": "ds_cost_by_user_table",
      "displayName": "Cost by Project/User Table Data",
      "query": "SELECT coalesce(custom_tags.project_name, 'Unattributed') as project, user_identity.email as user, sum(usage_unit_price * usage_quantity) as cost_usd, sum(usage_quantity) as dbus\nFROM system.billing.usage\nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1, 2 ORDER BY 3 DESC LIMIT 100"
    },
    {
      "name": "ds_unattributed_cost",
      "displayName": "Unattributed Cost Data",
      "query": "SELECT sum(usage_unit_price * usage_quantity) as unattributed_cost\nFROM system.billing.usage\nWHERE usage_date >= now() - interval 30 day AND custom_tags.project_name IS NULL"
    },
    {
      "name": "ds_cost_by_sku",
      "displayName": "Cost by SKU Data",
      "query": "SELECT date_trunc('week', usage_date) as week, sku_name, sum(usage_unit_price * usage_quantity) as cost_usd\nFROM system.billing.usage\nWHERE usage_date >= now() - interval 90 day\nGROUP BY 1, 2 ORDER BY 1, 2"
    },
    {
      "name": "ds_expensive_jobs_table",
      "displayName": "Expensive Jobs Table Data",
      "query": "SELECT job_name, sum(0.15 * (execution_duration / 1000 / 3600)) as estimated_cost, avg(0.15 * (execution_duration / 1000 / 3600)) as avg_cost_per_run \nFROM system.operational_data.jobs_history\nWHERE start_time >= now() - interval 30 day AND execution_duration is not null\nGROUP BY 1 ORDER BY 2 DESC LIMIT 10"
    },
    {
      "name": "ds_failed_jobs_table",
      "displayName": "Failed Jobs Table Data",
      "query": "SELECT job_name, 100 * sum(case when run_status = 'FAILED' then 1 else 0 end) / count(*) as failure_rate, sum(case when run_status = 'FAILED' then (0.15 * (execution_duration / 1000 / 3600)) else 0 end) as cost_of_failures \nFROM system.operational_data.jobs_history\nWHERE start_time >= now() - interval 30 day AND execution_duration is not null\nGROUP BY 1\nHAVING count(*) > 10\nORDER BY 2 DESC LIMIT 10"
    },
    {
      "name": "ds_job_perf_scatter",
      "displayName": "Job Perf Scatter Data",
      "query": "SELECT execution_duration / 60000 as duration_minutes, 0.15 * (execution_duration / 1000 / 3600) as cost_usd\nFROM system.operational_data.jobs_history\nWHERE start_time >= now() - interval 7 day AND execution_duration is not null\nLIMIT 1000"
    },
    {
      "name": "ds_users_by_bu",
      "displayName": "Users by BU Data",
      "query": "SELECT coalesce(custom_tags.business_unit, 'Unassigned') as business_unit, count(distinct user_identity.email) as user_count\nFROM system.billing.usage\nWHERE usage_date >= now() - interval 30 day\nGROUP BY 1 ORDER BY 2 DESC"
    },
    {
      "name": "ds_user_retention",
      "displayName": "User Retention Data",
      "query": "-- User retention is a highly complex query not suited for a single dashboard query.\n-- This is a placeholder demonstrating the expected output format.\nSELECT '2024-01' as cohort_month, 0 as month_after_join, 100 as retention_pct UNION ALL\nSELECT '2024-01' as cohort_month, 1 as month_after_join, 85 as retention_pct UNION ALL\nSELECT '2024-02' as cohort_month, 0 as month_after_join, 100 as retention_pct UNION ALL\nSELECT '2024-02' as cohort_month, 1 as month_after_join, 88 as retention_pct"
    },
    {
      "name": "ds_critical_assets_table",
      "displayName": "Critical Assets Table Data",
      "query": "SELECT object_name as table_name, count(*) as read_count, count(distinct request_params.user_id) as distinct_users\nFROM system.access.audit\nWHERE action_name IN ('generateTemporaryTableCredential', 'getCommandStreamResults')\nAND event_date >= now() - interval 30 day\nAND request_params.table_full_name IS NOT NULL\nGROUP BY 1 ORDER BY 2 DESC LIMIT 10"
    }
  ],
  "pages": [
    {
      "name": "p_exec_summary",
      "displayName": "ðŸ“Š Executive Summary",
      "layout": [
        {
          "widget": {
            "name": "w_total_spend",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_total_spend", "fields": [{"name": "total_cost"}], "disaggregated": true}}],
            "spec": {"version": 2, "widgetType": "counter", "encodings": {"value": {"fieldName": "total_cost"}}, "frame": {"showTitle": true, "title": "Total Spend (30d)"}}
          },
          "position": {"x": 0, "y": 0, "width": 3, "height": 4}
        },
        {
          "widget": {
            "name": "w_active_users",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_active_users", "fields": [{"name": "active_users"}], "disaggregated": true}}],
            "spec": {"version": 2, "widgetType": "counter", "encodings": {"value": {"fieldName": "active_users"}}, "frame": {"showTitle": true, "title": "Active Users (30d)"}}
          },
          "position": {"x": 3, "y": 0, "width": 3, "height": 4}
        },
        {
          "widget": {
            "name": "w_top_project",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_top_project", "fields": [{"name": "project"}], "disaggregated": true}}],
            "spec": {"version": 2, "widgetType": "counter", "encodings": {"value": {"fieldName": "project"}}, "frame": {"showTitle": true, "title": "Top Cost Driver (Project)"}}
          },
          "position": {"x": 6, "y": 0, "width": 3, "height": 4}
        },
        {
          "widget": {
            "name": "w_job_success",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_job_success", "fields": [{"name": "success_rate"}], "disaggregated": true}}],
            "spec": {"version": 2, "widgetType": "counter", "encodings": {"value": {"fieldName": "success_rate", "format": {"type": "number", "suffix": "%"}}}, "frame": {"showTitle": true, "title": "Job Success Rate"}}
          },
          "position": {"x": 9, "y": 0, "width": 3, "height": 4}
        },
        {
          "widget": {
            "name": "w_cost_trend",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_cost_trend", "fields": [{"name": "usage_date"}, {"name": "Current Period"}], "disaggregated": true}}],
            "spec": {"version": 3, "widgetType": "area", "encodings": {"x": {"fieldName": "usage_date", "scale": {"type": "temporal"}}, "y": {"fieldName": "Current Period", "scale": {"type": "quantitative"}}}, "frame": {"showTitle": true, "title": "Cost Trend vs. Previous Period"}}
          },
          "position": {"x": 0, "y": 4, "width": 6, "height": 8}
        },
        {
          "widget": {
            "name": "w_workload_cost",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_workload_cost", "fields": [{"name": "sku_name"}, {"name": "total_cost"}], "disaggregated": true}}],
            "spec": {"version": 3, "widgetType": "pie", "encodings": {"slice": {"fieldName": "total_cost"}, "color": {"fieldName": "sku_name"}}, "frame": {"showTitle": true, "title": "Cost by Workload"}}
          },
          "position": {"x": 6, "y": 4, "width": 6, "height": 8}
        },
        {
          "widget": {
            "name": "w_project_cost_breakdown",
            "queries": [{"name": "main_query", "query": {"datasetName": "ds_project_cost_breakdown", "fields": [{"name": "project"}, {"name": "total_cost"}], "disaggregated": true}}],
            "spec": {"version": 3, "widgetType": "bar", "encodings": {"x": {"fieldName": "total_cost", "scale": {"type": "quantitative"}}, "y": {"fieldName": "project", "scale": {"type": "categorical"}}}, "frame": {"showTitle": true, "title": "Cost Breakdown by Project/Team"}}
          },
          "position": {"x": 0, "y": 12, "width": 12, "height": 10}
        }
      ]
    }
  ]
}
